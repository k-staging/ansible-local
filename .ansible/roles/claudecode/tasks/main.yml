---
# ============================================
# Claude Code Native インストール
# ============================================
- name: check if claude is already installed
  ansible.builtin.command: which claude
  register: claude_installed_check
  ignore_errors: true
  changed_when: false

- name: get current claude version
  ansible.builtin.shell: |
    set -o pipefail
    claude --version | head -1 | awk '{print $1}'
  args:
    executable: /bin/bash
  register: claude_current_version
  changed_when: false
  when: claude_installed_check.rc == 0

- name: set version check result
  ansible.builtin.set_fact:
    claude_needs_update: "{{ claude_installed_check.rc != 0 or (claude_current_version.stdout | default('') != claude_code_version) }}"

- name: download Claude Code installer
  ansible.builtin.get_url:
    url: https://claude.ai/install.sh
    dest: /tmp/claude-install.sh
    mode: 0755
  when: claude_needs_update

- name: run Claude Code installer with version
  ansible.builtin.shell: CLAUDE_CODE_VERSION={{ claude_code_version }} /tmp/claude-install.sh
  when: claude_needs_update

- name: remove Claude Code installer
  ansible.builtin.file:
    path: /tmp/claude-install.sh
    state: absent
  when: claude_needs_update

# ============================================
# Claude Code ディレクトリ作成
# ============================================
- name: create Claude Code directories
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/{{ item | regex_replace('^~/', '') }}"
    state: directory
    mode: 0755
  loop: "{{ claudecode_dir }}"

# ============================================
# Claude Code 設定ファイル
# ============================================
- name: copy CLAUDE.md
  ansible.builtin.copy:
    src: "CLAUDE.md"
    dest: "{{ ansible_env.HOME }}/.claude/CLAUDE.md"
    mode: 0644

- name: copy CLAUDE.local.md (highest priority rules)
  ansible.builtin.copy:
    src: "CLAUDE.local.md"
    dest: "{{ ansible_env.HOME }}/.claude/CLAUDE.local.md"
    mode: 0644

- name: copy custom command files
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "{{ ansible_env.HOME }}/.claude/commands/{{ item }}"
    mode: 0644
  loop:
    - sequential-thinking.md
    - plan.md
    - team.md

- name: deploy settings.json to ~/.claude
  ansible.builtin.template:
    src: "settings.json.j2"
    dest: "{{ ansible_env.HOME }}/.claude/settings.json"
    mode: 0644

# ============================================
# Claude Code Agents
# ============================================
- name: copy Claude subagent files
  ansible.builtin.copy:
    src: "claude-agents/{{ item }}"
    dest: "{{ ansible_env.HOME }}/.claude/agents/{{ item }}"
    mode: 0644
  loop:
    - ansible-validator.md
    - infra-reviewer.md
    - docs-updater.md
    - rails-test-guardian.md
    - rails-security-auditor.md
    - rails-performance-optimizer.md
    - rails-db-migration-reviewer.md
    - rails-code-reviewer.md

# ============================================
# Claude Code Skills
# ============================================
- name: copy Claude skill files
  ansible.builtin.copy:
    src: "claude-skills/{{ item }}/SKILL.md"
    dest: "{{ ansible_env.HOME }}/.claude/skills/{{ item }}/SKILL.md"
    mode: 0644
  loop:
    - backend-dev
    - infra-quick-check
    - sql-helper

# ============================================
# MCP Servers 設定
# ============================================
- name: check if ~/.claude.json exists
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.claude.json"
  register: claude_json_stat

- name: check if jq is installed
  ansible.builtin.command: which jq
  register: jq_check
  ignore_errors: true
  changed_when: false

- name: update ~/.claude.json with mcpServers
  block:
    - name: copy mcpServers.json
      ansible.builtin.copy:
        src: "mcpServers.json"
        dest: "/tmp/mcpServers.json"
        mode: 0644

    - name: update ~/.claude.json with mcpServers
      ansible.builtin.shell: |
        jq '.mcpServers = $newMcpServers' \
          --argjson newMcpServers "$(cat /tmp/mcpServers.json)" \
          {{ ansible_env.HOME }}/.claude.json > /tmp/claude.json.tmp && \
        mv /tmp/claude.json.tmp {{ ansible_env.HOME }}/.claude.json
      changed_when: true

    - name: remove temporary mcpServers.json
      ansible.builtin.file:
        path: "/tmp/mcpServers.json"
        state: absent
  when:
    - claude_json_stat.stat.exists
    - jq_check.rc == 0

# ============================================
# Codex 設定
# ============================================
- name: copy AGENTS.md
  ansible.builtin.copy:
    src: "AGENTS.md"
    dest: "{{ ansible_env.HOME }}/.codex/AGENTS.md"
    mode: 0644

# ============================================
# Claude Code LSP プラグイン設定
# ============================================
- name: check claude command exists for plugins
  ansible.builtin.command: which claude
  register: claude_plugin_check
  ignore_errors: true
  changed_when: false

- name: install Claude Code LSP plugins from official marketplace
  ansible.builtin.command: "claude plugin install {{ item }}"
  loop: "{{ claude_code_lsp_plugins }}"
  register: plugin_install_result
  changed_when: "'Successfully installed' in plugin_install_result.stdout"
  failed_when: false
  when: claude_plugin_check.rc == 0

# Custom LSP plugins via local marketplace
- name: create custom-lsp marketplace directory structure
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.claude/plugins/custom-marketplace/{{ item }}"
    state: directory
    mode: 0755
  loop:
    - ".claude-plugin"
    - "plugins"

- name: create custom LSP plugin source directories
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.claude/plugins/custom-marketplace/plugins/{{ item.name }}"
    state: directory
    mode: 0755
  loop: "{{ claude_code_custom_lsp_plugins }}"

- name: create README for custom LSP plugins
  ansible.builtin.copy:
    content: "# {{ item.name }}\n{{ item.description }}\n"
    dest: "{{ ansible_env.HOME }}/.claude/plugins/custom-marketplace/plugins/{{ item.name }}/README.md"
    mode: 0644
  loop: "{{ claude_code_custom_lsp_plugins }}"

- name: deploy custom-lsp marketplace.json
  ansible.builtin.template:
    src: "custom_lsp_marketplace.json.j2"
    dest: "{{ ansible_env.HOME }}/.claude/plugins/custom-marketplace/.claude-plugin/marketplace.json"
    mode: 0644

- name: add custom-lsp marketplace
  ansible.builtin.command: "claude plugin marketplace add {{ ansible_env.HOME }}/.claude/plugins/custom-marketplace"
  register: marketplace_add_result
  changed_when: "'Successfully added' in marketplace_add_result.stdout"
  failed_when: false
  when: claude_plugin_check.rc == 0

- name: install custom LSP plugins
  ansible.builtin.command: "claude plugin install {{ item.name }}@custom-lsp"
  loop: "{{ claude_code_custom_lsp_plugins }}"
  register: custom_plugin_install_result
  changed_when: "'Successfully installed' in custom_plugin_install_result.stdout"
  failed_when: false
  when: claude_plugin_check.rc == 0
