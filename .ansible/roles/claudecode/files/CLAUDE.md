<!-- Last reviewed: 2026-01-31 -->

# CRITICAL RULES - MUST ALWAYS FOLLOW

以下のルールは全プロジェクトに適用され、例外なく必ず守ること。

## 0. CLAUDE.md 定期見直し
**セッション開始時に、上部の `Last reviewed` 日付を確認する。**

前回の見直しから1週間以上経過している場合：
1. `~/.claude/projects/` 配下のセッション履歴を確認し、過去1週間のやりとりを分析
2. 繰り返し発生している依頼パターンを特定
3. 自動化・ルール化できそうなものがあれば、ユーザーに提案
4. 承認を得たらこの CLAUDE.md に追記し、`Last reviewed` 日付を更新

## 1. 日本語で回答
すべての回答は日本語で行う。

## 2. 自主的な調査 - DO IT YOURSELF
**調査が必要な場合は、ユーザーに依頼せず自分で行う：**
- ファイルの読み込みが必要 → 自分でReadツールを使って読む
- コードの検索が必要 → 自分でGrep/Globで検索する
- WEB検索で情報が得られそう → 自分でWebSearchで調べる
- ドキュメントの確認が必要 → 自分でWebFetchで取得する

**ユーザーに「〜を確認してください」「〜を教えてください」と聞く前に、まず自分で調査すること。**
調査しても分からない場合のみ、ユーザーに質問する。

## 3. コード修正フロー
コード修正を伴う依頼を受けた場合、以下の手順で進める：

**⚠️ develop/main ブランチに直接コミットしないこと。コミット前に必ず作業ブランチを作成する。**

### Step 0: 作業ブランチ作成
1. 現在のブランチを確認する
2. `gh repo view --json defaultBranchRef --jq '.defaultBranchRef.name'` でデフォルトブランチを取得し、PRのベースブランチとして記憶する（セッション開始時の情報より実際のGitHub設定を優先）
3. 同じテーマの既存作業ブランチがあれば再利用を検討する（迷う場合はユーザーに確認）
4. develop または main にいる場合は、作業ブランチを作成して切り替える（例: `feature/`, `fix/`, `chore/` 等）
5. **作業ブランチにいることを確認してから** Step 1 に進む

### Step 1: 計画立案
1. **PRテンプレートを検索して読み込む**（Globで `.github/pull_request_template*`, `.github/PULL_REQUEST_TEMPLATE*`, `pull_request_template*` を検索し、見つかったらReadで内容を読む）
2. テンプレートがあればその構成に従い、なければ下記デフォルト構成でPRディスクリプション（概要・変更内容）を**簡潔に**作成
3. **作成したPRディスクリプション（途中版）をユーザーに提示し、問題ないか確認を取る**
4. 承認を得てから修正に着手

```markdown
## 概要
（変更の目的・背景）

## 変更内容
（具体的な変更点をリストで記載）
```

### Step 2: 実装
1. 必要に応じてSkillを呼び出しながらコードを修正
2. 修正完了後、変更ファイル一覧を確認

### Step 3: テスト
1. サブエージェント（`rails-test-guardian`等）またはSkillでテストを実行
2. テストが不足している場合は追加する
3. 全テストがパスすることを確認

### Step 4: レビュー
1. 適切なサブエージェント（`rails-code-reviewer`, `rails-security-auditor`, `ansible-validator`等）でレビュー
2. 指摘事項があれば修正

### Step 5: Push & PR作成
1. **Step 1で読み込んだPRテンプレートの構成に従ってPRディスクリプションを作成する**（テンプレートがない場合は下記デフォルト構成を使用）
2. PRのQA手順を追記する
3. **PRディスクリプションを `/tmp/pr_description.md` に書き出す**
4. ユーザーに push コマンドを提示し、実行を待つ：
   ```
   git push -u origin <branch>
   ```
5. push 完了後、`gh pr create` を**自分で実行**してPRを作成する
6. 作成したPRのURLをユーザーに報告する

### PRディスクリプションの構成（テンプレートがない場合）
```markdown
## 概要
（変更の目的・背景）

## 変更内容
（具体的な変更点）

## QA手順
（動作確認の手順）

## 影響範囲
（影響を受ける機能・画面）
```

**注意: PRディスクリプションは簡潔に記述すること。冗長な説明は避け、要点を端的にまとめる。**

## 4. Skills - 編集前に呼ぶ
**以下のファイルを編集する直前に、対応するSkillを必ず呼び出す：**

| File Pattern | Skill to Invoke |
|-------------|-----------------|
| `.rb`, `.py`, `.sql` | `backend-dev` |
| `Dockerfile`, `docker-compose*.yml`, `.ansible/`, `*.tf`, k8s manifests | `infra-quick-check` |
| ActiveRecord queries, raw SQL | `sql-helper` |

## 5. Agents - レビュー時に呼ぶ
**実装完了後、必ずサブエージェントでレビューを実施する：**
- Ansible変更 → `ansible-validator`, `infra-reviewer`
- Rails変更 → `rails-code-reviewer`, `rails-security-auditor`

---

# Claude Code グローバル設定

## 基本設定
- コマンドを提示する際は、必ず一行で記述すること（コピーしやすくするため）。複数行に分割しない。
- 出力する文章やコードの冒頭・末尾に不要なスペースを入れないこと。

## 編集モード（Shift+Tab で切り替え）

### 📋 Plan Mode（Shift+Tab 2回）
**複雑なタスクの実装前に詳細な計画を立てるモード**

#### いつ使うべきか
- 新機能の追加（複数ファイルにまたがる変更）
- アーキテクチャの変更
- リファクタリング（影響範囲が広い）
- 複雑なバグ修正
- データベーススキーマの変更

#### Plan Mode を使わない場合
- 単純なファイル修正（1〜2ファイル）
- タイポ修正
- ドキュメントの更新
- 明確で単純なタスク

### ⚡ Edit automatically（Shift+Tab 1回）
**ファイル編集を自動的に承認し、作業を高速化するモード**

#### 注意点
- **Git管理が必須**（意図しない変更をrevertできるように）
- 不安な場合は Esc キーで中断可能

---

## 詳細ルール

### Skill詳細

#### backend-dev
- **対象ファイル**: `.rb`, `.py`, `.sql`
- **役割**: ベストプラクティス適用、N+1防止、簡単なバグ修正

#### infra-quick-check
- **対象ファイル**: `Dockerfile`, `docker-compose*.yml`, `.ansible/`配下, `*.tf`, k8s manifest
- **役割**: 構文チェック、基本的なセキュリティチェック

#### sql-helper
- **対象コード**: ActiveRecordクエリ、生SQLクエリ
- **役割**: N+1問題防止、インデックス提案、クエリ最適化

### Agent詳細

#### Ansibleファイルのレビュー（.ansible/roles/配下を変更した場合）
1. `ansible-validator` サブエージェントで構文・ベストプラクティスをチェック
2. `infra-reviewer` サブエージェントでセキュリティ・保守性をレビュー

#### Railsファイルのレビュー（Railsプロジェクトを変更した場合）
1. **コード品質**: `rails-code-reviewer` サブエージェントでRails規約・アンチパターンをチェック
2. **セキュリティ**: `rails-security-auditor` サブエージェントで脆弱性を検出
3. **パフォーマンス** (必要に応じて): `rails-performance-optimizer` サブエージェントでN+1問題等を検出
4. **マイグレーション** (db/migrate/変更時): `rails-db-migration-reviewer` サブエージェントで安全性を確認
5. **テスト** (spec/変更時): `rails-test-guardian` サブエージェントでテストを実行

### カスタムスラッシュコマンド

#### /team - Agent Teams 協調作業モード（EXPERIMENTAL）
複雑なタスクを2人のエージェントチームで協調作業するモード。

**構成**:
- **Lead**: 計画立案 + 実装 + コミット担当
- **Reviewer**: 計画レビュー + 実装レビュー担当

**使い方**:
```
/team ユーザー認証機能にパスワードリセットを追加して
```

**ワークフロー**:
1. Lead が計画を立てる → Reviewer がレビュー
2. Lead が実装 → Reviewer がコードレビュー
3. Lead がコミット

**注意**:
- トークン消費が通常の2倍程度になる
- EXPERIMENTAL 機能（`CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1` で有効化）
- 最小限のエージェントで試すことを推奨

#### /sequential-thinking
Sequential thinking tool でタスクを深く分析する。

#### /plan
Plan Mode で複雑なタスクの実装計画を立てる。

### 効率化ルール
- コミットメッセージは変更内容から自動生成する
- 複数ファイルの読み込みや検索は並列で実行する

### テスト実行ルール
#### テストファイルを編集した場合
1. **即座にテストを実行する（ユーザーに依頼しない）**
2. テスト結果をユーザーに報告する
3. 失敗した場合は原因を調査し、修正する

#### 実装ファイルを編集した場合
1. **関連するテストを実行する（ユーザーに依頼しない）**
2. テスト結果をユーザーに報告する

### 変更の原則
- 明示的に依頼されない限り、不要なリファクタリングは避ける
- 変更前に影響範囲を調査し、既存テストの有無を確認
- プロジェクトのコーディング規約・ディレクトリ構造に従う

### ファイル削除時の確認ルール
ファイルを削除した場合、**必ず以下の関連箇所を確認・修正する**：
1. **インポート/require文** - 削除したファイルを参照しているコード
2. **設定ファイル** - ルーティング、設定、マニフェスト等での参照
3. **テストファイル** - 削除したファイルに対応するテスト
4. **ドキュメント** - README、CLAUDE.md等での言及

### ドキュメント更新の原則
- **プロジェクトCLAUDE.md**（リポジトリ直下やプロジェクトルート）はチーム全体に影響するため、**必ずユーザーに確認してから更新する**
- **グローバルCLAUDE.md**（~/.claude/CLAUDE.md）は個人設定なので自由に更新可能

### エラー対応
- エラーが発生したら即座に報告し、対処方法をユーザーと相談
- 繰り返し同じエラーで失敗する場合は、別のアプローチを提案
