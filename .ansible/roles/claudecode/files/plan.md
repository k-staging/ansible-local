---
description: Plan Mode で複雑なタスクの実装計画を立てる
---

# Plan Mode - 実装計画の作成

あなたは今から **Plan Mode** で動作します。このモードでは、コーディングを開始する前に、詳細な実装計画を作成し、ユーザーの承認を得ることに専念します。

## Plan Mode の目的

手戻りを最小化するために、実装前に以下を明確にします：
- どのファイルを変更するか
- どのような実装アプローチを取るか
- 影響範囲はどこまでか
- 考慮すべきリスクは何か

## 実行手順

### 1. タスクの理解と確認

まず、ユーザーの要求を正しく理解できているか確認してください：
- 要求の目的は何か
- 実現したい機能・変更は何か
- 制約条件はあるか
- 優先度は何か

不明点があれば、**必ず質問**してください。

### 2. 調査フェーズ

実装計画を立てるために必要な情報を収集します：
- 既存のコードベース構造の理解
- 関連ファイルの特定
- 使用されている技術スタック・パターンの確認
- 既存の類似実装の調査

**ツールの活用**:
- `Glob` で関連ファイルを検索
- `Grep` でコードパターンを調査
- `Read` で既存実装を理解
- `LSP` ツールでシンボル検索（goToDefinition, findReferences等）

### 3. 実装計画の作成

以下の形式で詳細な計画を作成してください：

```markdown
## 実装計画

### 📝 タスク概要
[タスクの目的と実現内容を簡潔に記述]

### 🎯 実装アプローチ
[どのような方針で実装するかを記述]

### 📁 変更ファイル
1. `path/to/file1.rb` - [変更内容の概要]
2. `path/to/file2.rb` - [変更内容の概要]
3. ...

### 🔧 実装ステップ
1. [ステップ1の詳細]
   - 具体的な変更内容
   - 使用する技術・ライブラリ
2. [ステップ2の詳細]
   ...

### ⚠️ 考慮事項・リスク
- [リスク1とその対策]
- [リスク2とその対策]
- ...

### ✅ テスト計画
- [どのようにテストするか]
- [テストケースの概要]

### 📚 影響範囲
- [この変更が影響する範囲]
- [関連する他の機能]
```

### 4. ユーザー承認の待機

計画を提示したら、**実装を開始せず**に以下を伝えてください：

```
上記の実装計画を確認してください。

- 問題なければ「実装を開始してください」とお伝えください
- 修正が必要な箇所があれば、具体的にご指示ください
- 追加で確認したい点があれば、お知らせください
```

### 5. フィードバックへの対応

ユーザーから修正指示があった場合：
- 計画を修正して再提示
- 必要に応じて追加調査を実施
- 修正した計画を再度承認待ちにする

### 6. 実装フェーズへの移行

ユーザーから承認を得たら：
- Plan Mode を終了
- 通常の実装モードに切り替え
- 承認された計画に従って実装を開始

## 重要な注意事項

### ❌ やってはいけないこと
- 計画なしにいきなりコードを書く
- ユーザーの承認なしに実装を開始する
- 曖昧な計画のまま進める
- 調査を省略する

### ✅ やるべきこと
- 具体的で詳細な計画を作成する
- 不明点は必ず質問する
- リスクを事前に洗い出す
- ユーザーの承認を明示的に得る

## 例

### 良い計画の例

```markdown
## 実装計画

### 📝 タスク概要
ユーザー認証機能にパスワードリセット機能を追加する

### 🎯 実装アプローチ
- トークンベースのパスワードリセットフローを実装
- メール送信にはActionMailerを使用
- トークンの有効期限は24時間

### 📁 変更ファイル
1. `app/models/user.rb` - リセットトークン生成・検証メソッドを追加
2. `app/controllers/password_resets_controller.rb` - 新規作成
3. `app/mailers/user_mailer.rb` - パスワードリセットメール送信メソッドを追加
4. `config/routes.rb` - パスワードリセットのルートを追加
5. `app/views/password_resets/` - ビューファイルを新規作成

### 🔧 実装ステップ
1. Userモデルにトークン管理機能を追加
   - `reset_password_token` カラム追加のマイグレーション作成
   - `generate_reset_password_token` メソッド実装
   - `reset_password_token_expired?` メソッド実装

2. PasswordResetsControllerを作成
   - `new`, `create`, `edit`, `update` アクションを実装
   - トークンの検証ロジック実装

3. メール送信機能の実装
   - UserMailerにリセットメール送信メソッド追加
   - メールテンプレート作成

4. ルーティング設定
   - RESTfulなルートを追加

### ⚠️ 考慮事項・リスク
- セキュリティ: トークンは十分にランダムである必要がある → `SecureRandom.urlsafe_base64` を使用
- 有効期限: 古いトークンが残り続けないよう定期的にクリーンアップが必要 → 別途rake taskを検討
- メール送信失敗時のハンドリング → エラーログを記録し、ユーザーに適切なメッセージを表示

### ✅ テスト計画
- Userモデル: トークン生成・検証のユニットテスト
- Controller: 各アクションのリクエストテスト
- メール送信: メールが正しく送信されることを確認
- 統合テスト: パスワードリセットの全フローをテスト

### 📚 影響範囲
- ユーザー認証周り全般
- メール送信機能
- データベーススキーマ（usersテーブル）
```

---

**Plan Mode を活用して、手戻りのない効率的な開発を実現しましょう！**
