" Colorsheme
syntax on
set background=dark
set t_Co=256
colorscheme gruvbox

" Airline
let g:airline#extensions#tabline#enabled = 1
let g:airline#extensions#tabline#show_buffers = 0
let g:airline#extensions#tabline#show_splits = 0
let g:airline#extensions#tabline#show_tabs = 1
let g:airline#extensions#tabline#show_tab_nr = 0
let g:airline#extensions#tabline#show_tab_type = 0
let g:airline#extensions#tabline#close_symbol = '×'
let g:airline#extensions#tabline#show_close_button = 0
let g:airline#extensions#tabline#formatter = 'unique_tail'
let g:airline#extensions#virtualenv#enabled = 1
if !exists('g:airline_symbols')
  let g:airline_symbols = {}
endif
nmap <Tab> <Plug>AirlineSelectPrevTab
nmap <S-Tab> <Plug>AirlineSelectNextTab
nmap <C-c> :tablast <bar> tabnew<CR>

" Eslint
autocmd BufWritePre *.tsx,*.ts,*.jsx,*.js EslintFixAll

" Gitgutter
set  signcolumn=yes

" terminal
tnoremap <Esc> <C-\><C-n>
command! -nargs=* T split | wincmd j | resize 20 | terminal <args>
autocmd TermOpen * startinsert

" fzf.vim
nnoremap <silent> <C-p>  :<C-u>Files<CR>
nnoremap <silent> gs  :<C-u>GFiles?<CR>
nnoremap <silent> gc  :<C-u>Commits<CR>
nnoremap <silent> gr  :<C-u>Rg<Space>
xnoremap gr  "sy:Rg<Space>"<C-r>=substitute(substitute(@s, '\n', '', 'g'), '/', '\\/', 'g')<CR>"
let $FZF_DEFAULT_COMMAND='rg --files --hidden -g "!.git" '
command! -bang -nargs=* Rg
  \ call fzf#vim#grep(
  \   'rg --hidden -g "!.git" --column --line-number --no-heading --color=always --smart-case -- '.shellescape(<q-args>), 1,
  \   fzf#vim#with_preview(), <bang>0)

" nvim-lspconfig
lua << EOF
local nvim_lsp = require('lspconfig')
local servers  = { 'bashls', 'eslint', 'gopls', 'graphql', 'pylsp', 'ruby_ls' }
for _, lsp in ipairs(servers) do
  nvim_lsp[lsp].setup {}
end

function goimports(timeout_ms)
  local context = { only = { "source.organizeImports" } }
  vim.validate { context = { context, "t", true } }

  local params = vim.lsp.util.make_range_params()
  params.context = context

  -- See the implementation of the textDocument/codeAction callback
  -- (lua/vim/lsp/handler.lua) for how to do this properly.
  local result = vim.lsp.buf_request_sync(0, "textDocument/codeAction", params, timeout_ms)
  if not result or next(result) == nil then return end
  local actions = result[1].result
  if not actions then return end
  local action = actions[1]

  -- textDocument/codeAction can return either Command[] or CodeAction[]. If it
  -- is a CodeAction, it can have either an edit, a command or both. Edits
  -- should be executed first.
  if action.edit or type(action.command) == "table" then
    if action.edit then
      vim.lsp.util.apply_workspace_edit(action.edit)
    end
    if type(action.command) == "table" then
      vim.lsp.buf.execute_command(action.command)
    end
  else
    vim.lsp.buf.execute_command(action)
  end
end
EOF
nnoremap <C-o> :<C-u>lua vim.lsp.buf.definition()<CR>
autocmd BufWritePre *.go call execute('lua vim.lsp.buf.formatting_sync()')
autocmd BufWritePre *.go lua goimports(1000)

" vim-startify
let g:startify_change_to_dir = 0
let g:startify_session_autoload = 1
let g:startify_session_persistence = 1
let g:startify_session_dir = '~/.nvim/session'
let g:startify_session_number = 5
let g:startify_custom_header = [
  \ '    ============================================',
  \ '     Neovim ( v{{ neovim_version }} ) ',
  \ '    ============================================',
  \]
let g:startify_lists = [
          \ { 'type': 'sessions',  'header': ['    Sessions'] },
          \ { 'type': 'dir',       'header': ['    MRU '. getcwd()] },
          \ ]

" fern.vim
let g:fern#default_hidden=1
nnoremap <C-n> :Fern . -reveal=% -drawer -toggle -width=40<CR>

" universal ctags
set tags+=.tags
let g:auto_ctags = 1
let g:auto_ctags_tags_name = '.tags'
let g:auto_ctags_tags_args = '--tag-relative --recurse --sort=yes'
let g:auto_ctags_directory_list = ['.git']
nnoremap <F3> :<C-u>tab stj <C-R>=expand('<cword>')<CR><CR>

" tagbar
nnoremap <S-o> :TagbarToggle<CR>

" キーバインド変更
nnoremap j gj
nnoremap k gk
nnoremap <C-h> <C-w>h
nnoremap <C-j> <C-w>j
nnoremap <C-k> <C-w>k
nnoremap <C-l> <C-w>l

" インデント関連の設定
set tabstop=8
set softtabstop=4
set shiftwidth=4
set expandtab
set smarttab
set autoindent
set backspace=indent,eol,start

" その他
set number
set splitright
set hls
set whichwrap=b,s,h,l,<,>,[,]
set cursorline
set cursorcolumn
set clipboard+=unnamedplus
set clipboard+=unnamed
set switchbuf+=usetab,newtab
set wildignore=assets
set termguicolors
let &t_8f = "\<Esc>[38;2;%lu;%lu;%lum"
let &t_8b = "\<Esc>[48;2;%lu;%lu;%lum"
set list
set listchars=tab:»-,trail:-,eol:↲,extends:»,precedes:«,nbsp:%

" 前回開いた行数から再開する
augroup vimrcEx
  au BufRead * if line("'\"") > 0 && line("'\"") <= line("$") |
  \ exe "normal g`\"" | endif
augroup END

" wsl用設定
if system('uname -a | grep microsoft') != ''
  augroup Yank
    au!
    autocmd TextYankPost * :call system('win32yank.exe -i', @")
  augroup END
  noremap <silent> p :call setreg('"',system('win32yank.exe -o'))<CR>""p
endif
