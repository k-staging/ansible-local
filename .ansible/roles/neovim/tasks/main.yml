---
- name: create directory
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: 0755
  with_items:
    - "{{ neovim_dir }}"

- name: install neovim (mac)
  block:
    - name: download neovim (mac)
      ansible.builtin.unarchive:
        src: "https://github.com/neovim/neovim/releases/download/v{{ neovim_version }}/nvim-macos-arm64.tar.gz"
        dest: "/usr/local/src/nvim/"
        remote_src: yes
        extra_opts: ["--strip-components=1"]
  when: ansible_distribution == 'MacOSX' 

- name: download neovim (linux)
  ansible.builtin.unarchive:
    src: "https://github.com/neovim/neovim/releases/download/v{{ neovim_version }}/nvim-linux64.tar.gz"
    dest: "/usr/local/src/nvim/"
    remote_src: yes
    extra_opts: ["--strip-components=1"]
  when: ansible_distribution == 'Ubuntu' 

- name: create neovim symlink
  ansible.builtin.file:
    src: "/usr/local/src/nvim/bin/nvim"
    dest: "/usr/local/bin/nvim"
    state: link
    force: yes
  become: yes

- name: copy init.vim
  ansible.builtin.template:
    src: "init.vim.j2"
    dest: "~/.config/nvim/init.vim"

- name: copy config.yml.j2
  ansible.builtin.template:
    src: "config.yml.j2"
    dest: "~/.config/sqls/config.yml"

- name: create common.sql file for sqls
  ansible.builtin.copy:
    content: |
      -- Common SQL file for sqls language server
      -- This file is used to enable sqls to start properly
      
    dest: "~/.local/share/nvim/common.sql"
    mode: 0644

- name: download nerd-fonts
  ansible.builtin.unarchive:
    src: "https://github.com/ryanoasis/nerd-fonts/archive/refs/tags/v{{ nerdfonts_version }}.tar.gz"
    dest: "/usr/local/src/"
    remote_src: yes
    creates: "/usr/local/src/nerd-fonts-{{ nerdfonts_version }}"

- name: install nerd-fonts
  ansible.builtin.command: "./install.sh"
  args:
    chdir: "/usr/local/src/nerd-fonts-{{ nerdfonts_version }}"
    creates: "~/.local/share/fonts/NerdFonts"

- name: install neovim plugin
  ansible.builtin.git:
    repo: "https://github.com/{{ item.name }}.git"
    dest: "{{ neovim_plugin_path }}/{{ item.name.split('/')[-1] }}"
    version: "{{ item.version }}"
    update: no
  with_items:
    - "{{ neovim_plugins }}"

- name: install fzf
  ansible.builtin.shell: ./install --all
  args:
    chdir: "{{ neovim_plugin_path }}/fzf"
    creates: "{{ ansible_env.HOME }}/.fzf.bash"

- name: make .claude directory
  ansible.builtin.file:
    path: "~/.claude"
    state: directory
    mode: 0755

- name: copy CLAUDE.md
  ansible.builtin.copy:
    src: "CLAUDE.md"
    dest: "~/.claude/CLAUDE.md"
    mode: 0644

- name: make .claude/commands directory
  ansible.builtin.file:
    path: "~/.claude/commands"
    state: directory
    mode: 0755

- name: copy sequential-thinking custom command
  ansible.builtin.copy:
    src: "sequential-thinking.md"
    dest: "~/.claude/commands/sequential-thinking.md"
    mode: 0644

- name: copy plan custom command
  ansible.builtin.copy:
    src: "plan.md"
    dest: "~/.claude/commands/plan.md"
    mode: 0644

- name: deploy settings.json to ~/.claude
  ansible.builtin.template:
    src: "settings.json.j2"
    dest: "~/.claude/settings.json"
    mode: 0644

- name: make .claude/agents directory
  ansible.builtin.file:
    path: "~/.claude/agents"
    state: directory
    mode: 0755

- name: copy claude subagent files
  ansible.builtin.copy:
    src: "claude-agents/{{ item }}"
    dest: "~/.claude/agents/{{ item }}"
    mode: 0644
  with_items:
    - ansible-validator.md
    - infra-reviewer.md
    - docs-updater.md
    - rails-test-guardian.md
    - rails-security-auditor.md
    - rails-performance-optimizer.md
    - rails-db-migration-reviewer.md
    - rails-code-reviewer.md

- name: make .claude/skills directories
  ansible.builtin.file:
    path: "~/.claude/skills/{{ item }}"
    state: directory
    mode: 0755
  with_items:
    - backend-dev
    - infra-quick-check
    - sql-helper

- name: copy claude skill files
  ansible.builtin.copy:
    src: "claude-skills/{{ item }}/SKILL.md"
    dest: "~/.claude/skills/{{ item }}/SKILL.md"
    mode: 0644
  with_items:
    - backend-dev
    - infra-quick-check
    - sql-helper

- name: install oxker (mac)
  block:
    - name: download oxker binary (mac)
      ansible.builtin.get_url:
        url: "https://github.com/mrjackwills/oxker/releases/download/v{{ oxker_version }}/oxker_apple_darwin_aarch64.tar.gz"
        dest: "/tmp/oxker_apple_darwin_aarch64.tar.gz"
        mode: 0644

    - name: extract oxker (mac)
      ansible.builtin.unarchive:
        src: "/tmp/oxker_apple_darwin_aarch64.tar.gz"
        dest: "/tmp/"
        remote_src: yes

    - name: install oxker binary (mac)
      ansible.builtin.copy:
        src: "/tmp/oxker"
        dest: "/usr/local/bin/oxker"
        mode: 0755
        remote_src: yes
      become: yes
  when: ansible_distribution == 'MacOSX'

- name: install oxker (linux)
  block:
    - name: download oxker binary (linux)
      ansible.builtin.get_url:
        url: "https://github.com/mrjackwills/oxker/releases/download/v{{ oxker_version }}/oxker_linux_x86_64.tar.gz"
        dest: "/tmp/oxker_linux_x86_64.tar.gz"
        mode: 0644

    - name: extract oxker (linux)
      ansible.builtin.unarchive:
        src: "/tmp/oxker_linux_x86_64.tar.gz"
        dest: "/tmp/"
        remote_src: yes

    - name: install oxker binary (linux)
      ansible.builtin.copy:
        src: "/tmp/oxker"
        dest: "/usr/local/bin/oxker"
        mode: 0755
        remote_src: yes
      become: yes
  when: ansible_distribution == 'Ubuntu'

- name: install lazygit (mac)
  block:
    - name: download lazygit binary (mac)
      ansible.builtin.get_url:
        url: "https://github.com/jesseduffield/lazygit/releases/download/v{{ lazygit_version }}/lazygit_{{ lazygit_version }}_Darwin_arm64.tar.gz"
        dest: "/tmp/lazygit_Darwin_arm64.tar.gz"
        mode: 0644

    - name: extract lazygit (mac)
      ansible.builtin.unarchive:
        src: "/tmp/lazygit_Darwin_arm64.tar.gz"
        dest: "/tmp/"
        remote_src: yes

    - name: install lazygit binary (mac)
      ansible.builtin.copy:
        src: "/tmp/lazygit"
        dest: "/usr/local/bin/lazygit"
        mode: 0755
        remote_src: yes
      become: yes
  when: ansible_distribution == 'MacOSX'

- name: install lazygit (linux)
  block:
    - name: download lazygit binary (linux)
      ansible.builtin.get_url:
        url: "https://github.com/jesseduffield/lazygit/releases/download/v{{ lazygit_version }}/lazygit_{{ lazygit_version }}_Linux_x86_64.tar.gz"
        dest: "/tmp/lazygit_Linux_x86_64.tar.gz"
        mode: 0644

    - name: extract lazygit (linux)
      ansible.builtin.unarchive:
        src: "/tmp/lazygit_Linux_x86_64.tar.gz"
        dest: "/tmp/"
        remote_src: yes

    - name: install lazygit binary (linux)
      ansible.builtin.copy:
        src: "/tmp/lazygit"
        dest: "/usr/local/bin/lazygit"
        mode: 0755
        remote_src: yes
      become: yes
  when: ansible_distribution == 'Ubuntu'

- name: remove Claude Code lock files
  ansible.builtin.shell: rm -rf ~/.local/state/claude/locks/
  ignore_errors: yes

- name: install Claude Code CLI
  ansible.builtin.shell: curl -fsSL https://claude.ai/install.sh | bash -s -- {{ claude_code_version }}

- name: check if ~/.claude.json exists
  ansible.builtin.stat:
    path: "~/.claude.json"
  register: claude_json_stat

- name: update ~/.claude.json with mcpServers
  block:
    - name: copy mcpServers.json
      ansible.builtin.copy:
        src: "mcpServers.json"
        dest: "/tmp/mcpServers.json"
        mode: 0644

    - name: update ~/.claude.json with mcpServers
      ansible.builtin.shell: |
        jq '.mcpServers = $newMcpServers' \
          --argjson newMcpServers "$(cat /tmp/mcpServers.json)" \
          ~/.claude.json > /tmp/claude.json.tmp && \
        mv /tmp/claude.json.tmp ~/.claude.json
      args:
        executable: /bin/bash

    - name: remove temporary mcpServers.json
      ansible.builtin.file:
        path: "/tmp/mcpServers.json"
        state: absent
  when: claude_json_stat.stat.exists

- name: make .serena directory
  ansible.builtin.file:
    path: "~/.serena"
    state: directory
    mode: 0755

- name: copy serena_config.yml
  ansible.builtin.copy:
    src: "serena_config.yml"
    dest: "~/.serena/serena_config.yml"
    mode: 0644

- name: make .codex directory
  ansible.builtin.file:
    path: "~/.codex"
    state: directory
    mode: 0755

- name: copy AGENTS.md
  ansible.builtin.copy:
    src: "AGENTS.md"
    dest: "~/.codex/AGENTS.md"
    mode: 0644

# ============================================
# Claude Code YOLO ãƒ¢ãƒ¼ãƒ‰ç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
# ============================================
- name: check if Docker is installed
  ansible.builtin.command: which docker
  register: docker_check
  ignore_errors: yes
  changed_when: false

- name: setup Claude Code YOLO environment
  when: docker_check.rc == 0
  block:
    - name: install devcontainer.vim (mac)
      block:
        - name: download devcontainer.vim binary (mac)
          ansible.builtin.get_url:
            url: "https://github.com/mikoto2000/devcontainer.vim/releases/download/v{{ devcontainer_vim_version }}/devcontainer.vim-darwin-arm64"
            dest: "/tmp/devcontainer.vim"
            mode: 0755

        - name: install devcontainer.vim binary (mac)
          ansible.builtin.copy:
            src: "/tmp/devcontainer.vim"
            dest: "/usr/local/bin/devcontainer.vim"
            mode: 0755
            remote_src: yes
          become: yes
      when: ansible_distribution == 'MacOSX'

    - name: install devcontainer.vim (linux)
      block:
        - name: download devcontainer.vim binary (linux)
          ansible.builtin.get_url:
            url: "https://github.com/mikoto2000/devcontainer.vim/releases/download/v{{ devcontainer_vim_version }}/devcontainer.vim-linux-amd64"
            dest: "/tmp/devcontainer.vim"
            mode: 0755

        - name: install devcontainer.vim binary (linux)
          ansible.builtin.copy:
            src: "/tmp/devcontainer.vim"
            dest: "/usr/local/bin/devcontainer.vim"
            mode: 0755
            remote_src: yes
          become: yes
      when: ansible_distribution == 'Ubuntu'

    - name: create Claude YOLO template directory
      ansible.builtin.file:
        path: "~/.config/claude-yolo-template/.devcontainer"
        state: directory
        mode: 0755

    - name: copy Claude YOLO devcontainer template files
      ansible.builtin.copy:
        src: "claude-yolo/{{ item }}"
        dest: "~/.config/claude-yolo-template/.devcontainer/{{ item }}"
        mode: "{{ '0755' if item == 'init-firewall.sh' else '0644' }}"
      with_items:
        - Dockerfile
        - devcontainer.json
        - devcontainer.vim.json
        - init-firewall.sh

    - name: display Claude YOLO setup message
      ansible.builtin.debug:
        msg: |
          âœ… Claude Code YOLO ãƒ¢ãƒ¼ãƒ‰ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ

          ğŸ“– ä½¿ã„æ–¹:
            1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼:
               cp -r ~/.config/claude-yolo-template/.devcontainer ./

            2. ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹• + Neovimå®Ÿè¡Œ:
               devcontainer.vim start . --nvim

            3. ã‚³ãƒ³ãƒ†ãƒŠå†…ã§Claude Code YOLOèµ·å‹•:
               <Ctrl-t> ã§ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ã
               claude --dangerously-skip-permissions

            4. ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢:
               devcontainer.vim stop .

          âš ï¸  æ³¨æ„: åˆå›èµ·å‹•æ™‚ã¯ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã«æ•°åˆ†ã‹ã‹ã‚Šã¾ã™

# ============================================
# Claude Code LSP ãƒ—ãƒ©ã‚°ã‚¤ãƒ³è¨­å®š
# ============================================
- name: make .claude-plugin directory
  ansible.builtin.file:
    path: "~/.claude-plugin"
    state: directory
    mode: 0755

- name: deploy plugin.json for Claude Code LSP
  ansible.builtin.template:
    src: "plugin.json.j2"
    dest: "~/.claude-plugin/plugin.json"
    mode: 0644

- name: check if .zshrc exists
  ansible.builtin.stat:
    path: "~/.zshrc"
  register: zshrc_stat

- name: add Claude Code LSP alias to .zshrc
  ansible.builtin.lineinfile:
    path: "~/.zshrc"
    line: "alias claude-lsp='ENABLE_LSP_TOOL=1 claude --plugin-dir ~/.claude-plugin'"
    create: yes
    mode: 0644
  when: zshrc_stat.stat.exists

- name: check if .bashrc exists
  ansible.builtin.stat:
    path: "~/.bashrc"
  register: bashrc_stat

- name: add Claude Code LSP alias to .bashrc
  ansible.builtin.lineinfile:
    path: "~/.bashrc"
    line: "alias claude-lsp='ENABLE_LSP_TOOL=1 claude --plugin-dir ~/.claude-plugin'"
    create: yes
    mode: 0644
  when: bashrc_stat.stat.exists

